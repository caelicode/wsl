#!/bin/bash
# CaeliCode WSL — Starship Theme Switcher
#
# Switch between bundled Starship prompt themes.
# Themes are stored in /opt/caelicode/themes/ and the active theme
# is symlinked to /etc/caelicode/starship.toml.
#
# Usage:
#   caelicode-theme                 # List themes and show active
#   caelicode-theme <name>          # Switch to a theme
#   caelicode-theme --preview       # Preview each theme's description

set -euo pipefail

THEMES_DIR="/opt/caelicode/themes"
ACTIVE_CONFIG="/etc/caelicode/starship.toml"

# Theme descriptions
declare -A DESCRIPTIONS=(
    [default]="CaeliCode classic — clean two-line prompt with cyan accents"
    [gruvbox-rainbow]="Gruvbox Rainbow — warm powerline segments with orange/yellow/green palette"
    [tokyo-night]="Tokyo Night — cool blue/purple tones inspired by the VS Code theme"
    [pastel-powerline]="Pastel Powerline — soft pink/coral/blue gradient segments"
    [jetpack]="Jetpack — minimalist left prompt with right-aligned info segments"
)

# Colors
cyan='\033[1;36m'
green='\033[1;32m'
yellow='\033[1;33m'
red='\033[1;31m'
dim='\033[0;37m'
reset='\033[0m'

get_active_theme() {
    if [ -L "$ACTIVE_CONFIG" ]; then
        local target
        target="$(readlink -f "$ACTIVE_CONFIG")"
        basename "$target" .toml
    else
        # Not a symlink — check if content matches a theme
        local active_hash
        active_hash="$(md5sum "$ACTIVE_CONFIG" 2>/dev/null | cut -d' ' -f1)"
        for theme_file in "$THEMES_DIR"/*.toml; do
            [ -f "$theme_file" ] || continue
            local theme_hash
            theme_hash="$(md5sum "$theme_file" | cut -d' ' -f1)"
            if [ "$active_hash" = "$theme_hash" ]; then
                basename "$theme_file" .toml
                return
            fi
        done
        echo "custom"
    fi
}

list_themes() {
    local active
    active="$(get_active_theme)"

    echo ""
    echo -e "  ${cyan}CaeliCode Starship Themes${reset}"
    echo -e "  ${dim}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${reset}"
    echo ""

    for theme_file in "$THEMES_DIR"/*.toml; do
        [ -f "$theme_file" ] || continue
        local name
        name="$(basename "$theme_file" .toml)"
        local desc="${DESCRIPTIONS[$name]:-No description}"

        if [ "$name" = "$active" ]; then
            echo -e "  ${green}● ${name}${reset}  ${dim}(active)${reset}"
        else
            echo -e "  ${dim}○${reset} ${name}"
        fi
        echo -e "    ${dim}${desc}${reset}"
        echo ""
    done

    echo -e "  ${dim}Switch theme:  caelicode-theme <name>${reset}"
    echo -e "  ${dim}Example:       caelicode-theme gruvbox-rainbow${reset}"
    echo ""
}

switch_theme() {
    local name="$1"
    local theme_file="${THEMES_DIR}/${name}.toml"

    if [ ! -f "$theme_file" ]; then
        echo -e "${red}Error: Theme '${name}' not found.${reset}" >&2
        echo "" >&2
        echo "Available themes:" >&2
        for f in "$THEMES_DIR"/*.toml; do
            [ -f "$f" ] || continue
            echo "  - $(basename "$f" .toml)" >&2
        done
        exit 1
    fi

    local active
    active="$(get_active_theme)"

    if [ "$name" = "$active" ]; then
        echo -e "${yellow}Already using theme '${name}'.${reset}"
        exit 0
    fi

    # Replace the active config with the theme file
    sudo cp "$theme_file" "$ACTIVE_CONFIG"

    echo -e "${green}Switched to theme '${name}'.${reset}"
    echo -e "${dim}Restart your shell or run: exec \$SHELL${reset}"
}

# ── Main ──────────────────────────────────────────────────────────
case "${1:-}" in
    ""|--list|-l)
        list_themes
        ;;
    --help|-h)
        cat <<'HELP'
Usage: caelicode-theme [OPTIONS] [THEME]

Switch between bundled Starship prompt themes.

Options:
  (no args)     List available themes and show which is active
  <name>        Switch to the named theme
  --list, -l    List available themes
  --help, -h    Show this help

Available themes:
  default            CaeliCode classic two-line prompt
  gruvbox-rainbow    Warm powerline with orange/yellow/green
  tokyo-night        Cool blue/purple VS Code-inspired
  pastel-powerline   Soft pink/coral/blue gradient
  jetpack            Minimalist with right-aligned segments

After switching, restart your shell:  exec $SHELL
HELP
        ;;
    *)
        switch_theme "$1"
        ;;
esac
