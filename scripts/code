#!/bin/bash
# CaeliCode WSL — VS Code launcher
#
# Wrapper that finds and launches VS Code from WSL without needing
# appendWindowsPath=true (which pollutes PATH and breaks mise).
# Probes standard VS Code install locations on the Windows side.

set -euo pipefail

# Cache the resolved path for subsequent calls
CACHE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/caelicode-vscode-path"

find_code_cli() {
    # Get Windows username via environment or wslvar
    local win_user
    win_user="$(
        /mnt/c/Windows/System32/cmd.exe /C "echo %USERNAME%" 2>/dev/null | tr -d '\r'
    )" || true

    # Base directories to probe (user install, system install, scoop)
    local dirs=()

    if [ -n "${win_user:-}" ]; then
        dirs+=(
            "/mnt/c/Users/${win_user}/AppData/Local/Programs/Microsoft VS Code/bin"
            "/mnt/c/Users/${win_user}/scoop/apps/vscode/current/bin"
        )
    fi

    dirs+=(
        "/mnt/c/Program Files/Microsoft VS Code/bin"
        "/mnt/c/Program Files (x86)/Microsoft VS Code/bin"
    )

    # For each directory, check code.cmd first (most common on Windows),
    # then the extensionless script.
    for dir in "${dirs[@]}"; do
        for name in code.cmd code; do
            if [ -f "${dir}/${name}" ]; then
                echo "${dir}/${name}"
                return 0
            fi
        done
    done

    return 1
}

# Try cached path first
if [ -f "$CACHE_FILE" ]; then
    VSCODE_PATH="$(cat "$CACHE_FILE")"
    if [ -f "$VSCODE_PATH" ]; then
        exec "$VSCODE_PATH" "$@"
    fi
    # Cached path is stale — remove and re-probe
    rm -f "$CACHE_FILE"
fi

# Probe for VS Code
VSCODE_PATH="$(find_code_cli)" || {
    echo "error: VS Code not found on the Windows side." >&2
    echo "" >&2
    echo "Install VS Code on Windows from: https://code.visualstudio.com" >&2
    echo "Make sure to check 'Add to PATH' during installation." >&2
    exit 1
}

# Cache the path for next time
mkdir -p "$(dirname "$CACHE_FILE")"
echo "$VSCODE_PATH" > "$CACHE_FILE"

exec "$VSCODE_PATH" "$@"
