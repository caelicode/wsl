# CaeliCode WSL — Build, Test & Release
# Single workflow: builds all profiles → tests → semantic-release → publish assets.
# The build job validates images with a SHA version. On release, publish-assets
# rebuilds from GHA cache with the correct version tag for the final tar.gz.

name: Build & Release

on:
  push:
    branches: [main]
    paths-ignore: ["docs/**", "*.md", "LICENSE"]
  pull_request:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build ${{ matrix.profile }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        profile: [base, sre, dev, data]
        include:
          - profile: base
            target: base-image
            test_script: test-base.sh
          - profile: sre
            target: sre-image
            test_script: test-sre.sh
          - profile: dev
            target: dev-image
            test_script: test-dev.sh
          - profile: data
            target: data-image
            test_script: test-data.sh

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build ${{ matrix.profile }} image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: .
          target: ${{ matrix.target }}
          build-args: VERSION=${{ github.sha }}
          tags: caelicode-wsl:${{ matrix.profile }}
          load: true
          cache-from: type=gha,scope=${{ matrix.profile }}
          cache-to: type=gha,mode=max,scope=${{ matrix.profile }}
          secrets: |
            github_token=${{ secrets.GITHUB_TOKEN }}

      - name: Run ${{ matrix.profile }} tests
        run: |
          docker run --rm caelicode-wsl:${{ matrix.profile }} \
            bash /opt/caelicode/test/${{ matrix.test_script }}

      - name: Run networking tests
        run: |
          docker run --rm caelicode-wsl:${{ matrix.profile }} \
            bash /opt/caelicode/test/test-networking.sh

      - name: Check image size
        run: |
          SIZE=$(docker image inspect caelicode-wsl:${{ matrix.profile }} --format '{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Image size: ${SIZE_MB}MB"

          # Fail if image exceeds size limits (MB)
          # base: ~1100MB (Python + modern CLI tools + zsh/oh-my-zsh)
          # sre:  ~3500MB (base + k8s + IaC + AWS/Azure/GCloud CLIs)
          # dev:  ~4500MB (base + Node/Go/Rust/Java/Bun + dev tools)
          # data: ~1800MB (base + dbt + jupyter + duckdb + DB clients)
          case "${{ matrix.profile }}" in
            base) MAX=1500 ;;
            sre)  MAX=5000 ;;
            dev)  MAX=5000 ;;
            data) MAX=2000 ;;
          esac

          if [ "$SIZE_MB" -gt "$MAX" ]; then
            echo "::error::Image size (${SIZE_MB}MB) exceeds limit (${MAX}MB)"
            exit 1
          fi

  lint:
    name: Lint scripts
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: ShellCheck scripts
        run: |
          shellcheck -x scripts/*.sh scripts/caelicode-update scripts/code scripts/caelicode-theme build.sh test/*.sh

      - name: Validate Dockerfile
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

  release:
    name: Semantic Release
    needs: [build, lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-24.04
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 22

      - name: Install semantic-release
        run: npm install --no-save semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/github conventional-changelog-conventionalcommits

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          # Capture the latest tag BEFORE semantic-release runs
          BEFORE_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "Tag before: $BEFORE_TAG"

          npx semantic-release

          # Fetch the tag that semantic-release may have pushed
          git fetch --tags

          AFTER_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "Tag after: $AFTER_TAG"

          if [ "$BEFORE_TAG" != "$AFTER_TAG" ] && [ "$AFTER_TAG" != "none" ]; then
            echo "new_release_published=true" >> "$GITHUB_OUTPUT"
            echo "new_release_version=${AFTER_TAG#v}" >> "$GITHUB_OUTPUT"
            echo "New release: $AFTER_TAG"
          else
            echo "new_release_published=false" >> "$GITHUB_OUTPUT"
            echo "No new release created"
          fi

  publish-assets:
    name: Publish ${{ matrix.profile }}
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: true
      matrix:
        profile: [base, sre, dev, data]
        include:
          - profile: base
            target: base-image
          - profile: sre
            target: sre-image
          - profile: dev
            target: dev-image
          - profile: data
            target: data-image

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Rebuild ${{ matrix.profile }} with release version (cache hit)
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: .
          target: ${{ matrix.target }}
          build-args: VERSION=v${{ needs.release.outputs.new_release_version }}
          tags: caelicode-wsl:${{ matrix.profile }}
          load: true
          cache-from: type=gha,scope=${{ matrix.profile }}
          secrets: |
            github_token=${{ secrets.GITHUB_TOKEN }}

      - name: Export tar
        run: |
          mkdir -p dist
          CONTAINER=$(docker run --privileged -dt caelicode-wsl:${{ matrix.profile }} bash)
          docker export "$CONTAINER" | gzip > dist/caelicode-wsl-${{ matrix.profile }}.tar.gz
          docker rm -f "$CONTAINER"

      - name: Generate checksum
        run: |
          cd dist
          sha256sum caelicode-wsl-${{ matrix.profile }}.tar.gz > caelicode-wsl-${{ matrix.profile }}.sha256

      - name: Upload release artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: release-${{ matrix.profile }}
          path: dist/

  publish-release:
    name: Publish GitHub Release
    needs: [release, publish-assets]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Download all release artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          path: dist
          pattern: release-*
          merge-multiple: true

      - name: Generate SBOM
        run: |
          python3 -c "
          import json, tomllib, pathlib

          sbom = {
              'bomFormat': 'CycloneDX',
              'specVersion': '1.5',
              'version': 'v${{ needs.release.outputs.new_release_version }}',
              'components': []
          }

          for toml_file in sorted(pathlib.Path('profiles').glob('*.toml')):
              with open(toml_file, 'rb') as f:
                  data = tomllib.load(f)
              profile = toml_file.stem
              for tool, version in data.get('tools', {}).items():
                  sbom['components'].append({
                      'type': 'application',
                      'name': tool,
                      'version': version,
                      'group': f'caelicode-wsl/{profile}'
                  })

          print(json.dumps(sbom, indent=2))
          " > dist/sbom.json

      - name: Merge checksums
        run: |
          cat dist/*.sha256 > dist/checksums.txt

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          append_body: true
          body: |

            ---

            ### Profile images
            | Profile | Description |
            |---------|-------------|
            | `caelicode-wsl-base.tar.gz` | Core tools (git, curl, jq, Python, mise) |
            | `caelicode-wsl-sre.tar.gz` | SRE/Platform (kubectl, helm, terraform, k9s, argocd, trivy) |
            | `caelicode-wsl-dev.tar.gz` | Development (Node.js, Go, Rust, podman, uv) |
            | `caelicode-wsl-data.tar.gz` | Data Engineering (Python, dbt, PostgreSQL client, uv) |

            ### Install
            ```powershell
            wsl --import caelicode-sre C:\wsl\caelicode caelicode-wsl-sre.tar.gz
            wsl -d caelicode-sre
            ```

            ### Verify
            ```bash
            caelicode-health
            ```

            See [Getting Started](docs/getting-started.md) for full instructions.
          files: |
            dist/*.tar.gz
            dist/*.sha256
            dist/checksums.txt
            dist/sbom.json
          draft: false
          prerelease: false
