# CaeliCode WSL â€” Build & Test Matrix
# Builds all 4 profiles in parallel, runs test suites inside each image.
# On main: after all builds pass, semantic-release creates a version tag
# which triggers the release workflow.

name: Build & Test

on:
  push:
    branches: [main]
    paths-ignore: ["docs/**", "*.md", "LICENSE"]
  pull_request:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build ${{ matrix.profile }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        profile: [base, sre, dev, data]
        include:
          - profile: base
            target: base-image
            test_script: test-base.sh
          - profile: sre
            target: sre-image
            test_script: test-sre.sh
          - profile: dev
            target: dev-image
            test_script: test-dev.sh
          - profile: data
            target: data-image
            test_script: test-data.sh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.profile }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: ${{ matrix.target }}
          build-args: VERSION=${{ github.sha }}
          tags: caelicode-wsl:${{ matrix.profile }}
          load: true
          cache-from: type=gha,scope=${{ matrix.profile }}
          cache-to: type=gha,mode=max,scope=${{ matrix.profile }}

      - name: Run ${{ matrix.profile }} tests
        run: |
          docker run --rm caelicode-wsl:${{ matrix.profile }} \
            bash /opt/caelicode/test/${{ matrix.test_script }}

      - name: Run networking tests
        run: |
          docker run --rm caelicode-wsl:${{ matrix.profile }} \
            bash /opt/caelicode/test/test-networking.sh

      - name: Check image size
        run: |
          SIZE=$(docker image inspect caelicode-wsl:${{ matrix.profile }} --format '{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Image size: ${SIZE_MB}MB"

          # Fail if image exceeds size limits (MB, ~20% headroom over observed sizes)
          case "${{ matrix.profile }}" in
            base) MAX=850  ;;
            sre)  MAX=1700 ;;
            dev)  MAX=3000 ;;
            data) MAX=1100 ;;
          esac

          if [ "$SIZE_MB" -gt "$MAX" ]; then
            echo "::error::Image size (${SIZE_MB}MB) exceeds limit (${MAX}MB)"
            exit 1
          fi

      - name: Export tar artifact
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p images
          CONTAINER=$(docker run --privileged -dt caelicode-wsl:${{ matrix.profile }} bash)
          docker export "$CONTAINER" | gzip > images/caelicode-wsl-${{ matrix.profile }}.tar.gz
          docker rm -f "$CONTAINER"
          sha256sum images/caelicode-wsl-${{ matrix.profile }}.tar.gz > images/caelicode-wsl-${{ matrix.profile }}.sha256

      - name: Upload build artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: caelicode-wsl-${{ matrix.profile }}
          path: images/
          retention-days: 7

  lint:
    name: Lint scripts
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: ShellCheck scripts
        run: |
          shellcheck -x scripts/*.sh build.sh test/*.sh || true

      - name: Validate Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: error

  release:
    name: Semantic Release
    needs: [build, lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install semantic-release
        run: npm install --no-save semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/github conventional-changelog-conventionalcommits

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: npx semantic-release
